<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.47">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ravi Shankar">

<title>advanced_data_ingestion_techniques – Data Down To Earth</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../logo.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
<link rel="stylesheet" href="../../content.css">
<meta property="og:title" content="– Data Down To Earth">
<meta property="og:site_name" content="Data Down To Earth">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Data Down To Earth</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-projects" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Projects</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-projects">    
        <li>
    <a class="dropdown-item" href="../../../projects/dsml_projects.html">
 <span class="dropdown-text">Data Science and ML Projects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../projects/genai_projects.html">
 <span class="dropdown-text">Generative AI Projects</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../../../topics/statistics.html">
 <span class="dropdown-text">Statistics &amp; Probability</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../topics/machine_learning.html">
 <span class="dropdown-text">Machine Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../topics/de.html">
 <span class="dropdown-text">Data Engineering</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../topics/generative_ai.html">
 <span class="dropdown-text">Generative AI</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../topics/public_health.html">
 <span class="dropdown-text">Public Health</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../topics/product_sense.html">
 <span class="dropdown-text">Product Sense</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../blogs/blogs.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/iamrsps"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/iamravishankar/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
</div>



<div class="quarto-title-meta column-page">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ravi Shankar </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="chapter-8-advanced-data-ingestion-techniques" class="level1 text-content">
<h1>Chapter 8: Advanced Data Ingestion Techniques</h1>
<section id="change-data-capture-cdc-methods" class="level2">
<h2 class="anchored" data-anchor-id="change-data-capture-cdc-methods">Change Data Capture (CDC) Methods</h2>
<section id="definition" class="level3">
<h3 class="anchored" data-anchor-id="definition">Definition</h3>
<section id="cdc-definition" class="level4">
<h4 class="anchored" data-anchor-id="cdc-definition">CDC Definition</h4>
<p>Change Data Capture (CDC) refers to a set of processes and technologies used to identify and capture changes made to data in a database so that these changes can be propagated to downstream systems. This approach is crucial for maintaining data consistency and enabling real-time data integration across multiple systems. CDC methods capture insertions, updates, and deletions, which are then processed and loaded into data warehouses, data lakes, or other databases.</p>
</section>
</section>
<section id="log-based-cdc" class="level3">
<h3 class="anchored" data-anchor-id="log-based-cdc">Log-based CDC</h3>
<section id="definition-1" class="level4">
<h4 class="anchored" data-anchor-id="definition-1">Definition</h4>
<p>Log-based CDC captures changes directly from the database’s transaction logs, which are logs that record all transactions and the changes they bring about in the database. This method is efficient as it minimizes the impact on the source database since it leverages existing mechanisms used for database recovery and replication.</p>
</section>
<section id="example" class="level4">
<h4 class="anchored" data-anchor-id="example">Example</h4>
<p>Debezium, an open-source CDC tool, uses log-based CDC to stream changes from databases such as MySQL, PostgreSQL, MongoDB, and others into Apache Kafka. Debezium reads the transaction logs and converts database changes into a stream of change events.</p>
</section>
<section id="advantages" class="level4">
<h4 class="anchored" data-anchor-id="advantages">Advantages</h4>
<ul>
<li>High efficiency</li>
<li>Low latency</li>
<li>Minimal impact on the source database</li>
<li>Ability to capture all types of changes (including deletes)</li>
<li>Potential for real-time data replication and synchronization</li>
</ul>
</section>
<section id="challenges" class="level4">
<h4 class="anchored" data-anchor-id="challenges">Challenges</h4>
<ul>
<li>Requires access to the database transaction logs, which may involve complex setup and configuration</li>
<li>Not all databases provide direct access to transaction logs, and proprietary formats may complicate integration</li>
</ul>
</section>
</section>
<section id="polling-based-cdc" class="level3">
<h3 class="anchored" data-anchor-id="polling-based-cdc">Polling-based CDC</h3>
<section id="definition-2" class="level4">
<h4 class="anchored" data-anchor-id="definition-2">Definition</h4>
<p>Polling-based CDC involves periodically querying the database to detect changes by comparing the current state of the data with a previously captured snapshot. This method is typically less efficient than log-based CDC and can introduce a significant load on the source database.</p>
</section>
<section id="example-1" class="level4">
<h4 class="anchored" data-anchor-id="example-1">Example</h4>
<p>A Python script running every hour that queries a database table for records with a timestamp column greater than the last queried timestamp. This approach detects new and updated records since the last polling interval.</p>
</section>
<section id="advantages-1" class="level4">
<h4 class="anchored" data-anchor-id="advantages-1">Advantages</h4>
<ul>
<li>Simpler to implement</li>
<li>Does not require access to transaction logs</li>
<li>Can be used with any database that supports querying</li>
<li>Suitable for environments where log-based CDC is not feasible</li>
</ul>
</section>
<section id="challenges-1" class="level4">
<h4 class="anchored" data-anchor-id="challenges-1">Challenges</h4>
<ul>
<li>Higher latency due to the periodic nature of polling</li>
<li>Increased performance impact on the source database because of frequent and potentially expensive queries</li>
<li>Difficulties in capturing delete operations accurately</li>
</ul>
</section>
</section>
<section id="trigger-based-cdc" class="level3">
<h3 class="anchored" data-anchor-id="trigger-based-cdc">Trigger-based CDC</h3>
<section id="definition-3" class="level4">
<h4 class="anchored" data-anchor-id="definition-3">Definition</h4>
<p>Trigger-based CDC uses database triggers to capture changes. Triggers are database procedures that are automatically executed in response to certain events on a particular table or view, such as INSERT, UPDATE, or DELETE operations.</p>
</section>
<section id="example-2" class="level4">
<h4 class="anchored" data-anchor-id="example-2">Example</h4>
<p>In a PostgreSQL database, a trigger can be set up to log changes to an audit table whenever a row in a target table is inserted, updated, or deleted. This audit table is then read by an ETL process to capture the changes.</p>
</section>
<section id="advantages-2" class="level4">
<h4 class="anchored" data-anchor-id="advantages-2">Advantages</h4>
<ul>
<li>Can capture changes in near real-time</li>
<li>Provides flexibility to capture specific types of changes</li>
<li>Does not require access to transaction logs</li>
<li>Can be customized to suit various business needs</li>
</ul>
</section>
<section id="challenges-2" class="level4">
<h4 class="anchored" data-anchor-id="challenges-2">Challenges</h4>
<ul>
<li>Introduces additional overhead on the database due to the operations performed by triggers, which can affect performance</li>
<li>As database schemas evolve, maintaining triggers can become complex and error-prone</li>
</ul>
<hr>
</section>
</section>
</section>
<section id="tools" class="level2">
<h2 class="anchored" data-anchor-id="tools">Tools</h2>
<section id="debezium" class="level3">
<h3 class="anchored" data-anchor-id="debezium">Debezium</h3>
<section id="overview" class="level4">
<h4 class="anchored" data-anchor-id="overview">Overview</h4>
<p>Debezium is an open-source CDC platform that captures changes from databases and streams them into Apache Kafka. It supports log-based CDC, providing a high-throughput and low-latency solution for real-time data integration.</p>
</section>
<section id="supported-databases" class="level4">
<h4 class="anchored" data-anchor-id="supported-databases">Supported Databases</h4>
<p>Debezium supports a variety of databases, including MySQL, PostgreSQL, MongoDB, SQL Server, and Oracle. It leverages the native transaction logs of these databases to capture changes.</p>
</section>
<section id="features" class="level4">
<h4 class="anchored" data-anchor-id="features">Features</h4>
<ul>
<li>Supports schema evolution, handling changes to database schemas and propagating these changes downstream</li>
<li>Ensures transactional consistency by maintaining the order of events as they occur in the source database</li>
<li>Integrates seamlessly with Kafka, providing exactly-once semantics through Kafka’s transactional capabilities</li>
</ul>
</section>
</section>
<section id="oracle-goldengate" class="level3">
<h3 class="anchored" data-anchor-id="oracle-goldengate">Oracle GoldenGate</h3>
<section id="overview-1" class="level4">
<h4 class="anchored" data-anchor-id="overview-1">Overview</h4>
<p>Oracle GoldenGate is a comprehensive software package for real-time data integration and replication. It supports log-based CDC and offers robust capabilities for high availability, data migrations, and transactional change data capture.</p>
</section>
<section id="supported-databases-1" class="level4">
<h4 class="anchored" data-anchor-id="supported-databases-1">Supported Databases</h4>
<p>GoldenGate supports a wide range of databases, including Oracle, SQL Server, DB2, MySQL, PostgreSQL, and others, making it suitable for heterogeneous database environments.</p>
</section>
<section id="features-1" class="level4">
<h4 class="anchored" data-anchor-id="features-1">Features</h4>
<ul>
<li>High performance and low latency</li>
<li>Supports complex topologies</li>
<li>Ensures data consistency across heterogeneous environments</li>
<li>Offers features such as data transformation, filtering, and conflict detection and resolution</li>
</ul>
</section>
</section>
<section id="aws-database-migration-service-dms" class="level3">
<h3 class="anchored" data-anchor-id="aws-database-migration-service-dms">AWS Database Migration Service (DMS)</h3>
<section id="overview-2" class="level4">
<h4 class="anchored" data-anchor-id="overview-2">Overview</h4>
<p>AWS DMS is a managed cloud service that facilitates the migration of databases to AWS with minimal downtime. It supports both full load and CDC methods, ensuring that source and target databases remain in sync throughout the migration process.</p>
</section>
<section id="supported-databases-2" class="level4">
<h4 class="anchored" data-anchor-id="supported-databases-2">Supported Databases</h4>
<p>AWS DMS supports a wide range of databases, including Amazon RDS, Aurora, SQL Server, MySQL, MariaDB, PostgreSQL, Oracle, and others. It allows for heterogeneous database migrations, such as migrating from an on-premises Oracle database to Amazon Aurora.</p>
</section>
<section id="features-2" class="level4">
<h4 class="anchored" data-anchor-id="features-2">Features</h4>
<ul>
<li>Simplifies the migration process by automating many of the complex tasks involved</li>
<li>Integrates with other AWS services, such as AWS Schema Conversion Tool (AWS SCT) for schema transformation</li>
<li>Provides monitoring and alerting capabilities to ensure a smooth migration</li>
</ul>
<hr>
</section>
</section>
</section>
<section id="handling-schema-changes-in-data-ingestion" class="level2">
<h2 class="anchored" data-anchor-id="handling-schema-changes-in-data-ingestion">Handling Schema Changes in Data Ingestion</h2>
<section id="definition-4" class="level3">
<h3 class="anchored" data-anchor-id="definition-4">Definition</h3>
<p>Handling schema changes in data ingestion involves managing and adapting to changes in the source database schema, such as adding or removing columns, changing data types, or modifying table structures, without disrupting the data ingestion process. This ensures data integrity and consistency across systems.</p>
</section>
<section id="techniques" class="level3">
<h3 class="anchored" data-anchor-id="techniques">Techniques</h3>
<section id="schema-evolution-support" class="level4">
<h4 class="anchored" data-anchor-id="schema-evolution-support">Schema Evolution Support</h4>
<p>Tools like Debezium automatically detect and handle schema changes by capturing metadata about the changes and propagating this information to downstream systems. This allows the ingestion pipeline to adjust dynamically to schema modifications.</p>
</section>
<section id="schema-registry" class="level4">
<h4 class="anchored" data-anchor-id="schema-registry">Schema Registry</h4>
<p>A schema registry, such as the Confluent Schema Registry, manages and versions schemas for data streams. It ensures that producers and consumers of data adhere to a consistent schema, preventing data processing errors due to schema mismatches. The registry can enforce compatibility rules, such as backward or forward compatibility, to manage schema evolution.</p>
</section>
<section id="backward-and-forward-compatibility" class="level4">
<h4 class="anchored" data-anchor-id="backward-and-forward-compatibility">Backward and Forward Compatibility</h4>
<p>Designing data processing systems to handle both old and new schema versions allows for seamless transitions and updates. Backward compatibility ensures that new data can be processed by older consumers, while forward compatibility allows new consumers to process old data without issues.</p>
</section>
</section>
<section id="example-3" class="level3">
<h3 class="anchored" data-anchor-id="example-3">Example</h3>
<p>A retail company using Kafka and a schema registry to manage evolving product data schemas. The schema registry ensures that any changes to the product data schema, such as adding new fields for product attributes, are propagated to all consumers without disrupting data processing. This approach helps maintain data quality and consistency across various applications consuming the product data.</p>
<hr>
</section>
</section>
<section id="exactly-once-processing-semantics" class="level2">
<h2 class="anchored" data-anchor-id="exactly-once-processing-semantics">Exactly-Once Processing Semantics</h2>
<section id="definition-5" class="level3">
<h3 class="anchored" data-anchor-id="definition-5">Definition</h3>
<p>Exactly-once processing semantics ensure that each data record is processed only once, preventing duplicates and ensuring data accuracy. This is critical in distributed systems where network failures, retries, and other issues can lead to multiple processing attempts, potentially causing inconsistencies in data.</p>
</section>
<section id="techniques-1" class="level3">
<h3 class="anchored" data-anchor-id="techniques-1">Techniques</h3>
<section id="idempotent-operations" class="level4">
<h4 class="anchored" data-anchor-id="idempotent-operations">Idempotent Operations</h4>
<p>Designing operations to be idempotent means that applying the same operation multiple times has the same effect as applying it once. For example, an idempotent write operation to a database might include a unique identifier for each transaction, ensuring that duplicate transactions do not result in duplicate data entries.</p>
</section>
<section id="transaction-management" class="level4">
<h4 class="anchored" data-anchor-id="transaction-management">Transaction Management</h4>
<p>Using transaction management ensures that a set of operations either all succeed or all fail, preventing partial updates and ensuring consistency. This often involves techniques such as two-phase commit or distributed transactions to maintain atomicity across multiple systems.</p>
</section>
<section id="kafka-exactly-once-semantics-eos" class="level4">
<h4 class="anchored" data-anchor-id="kafka-exactly-once-semantics-eos">Kafka Exactly-Once Semantics (EOS)</h4>
<p>Kafka’s EOS ensures that messages are delivered and processed exactly once. This is achieved using idempotent producers, which guarantee that messages are written to a topic exactly once, and transactional consumers, which ensure that messages are processed exactly once, maintaining data integrity and consistency.</p>
</section>
</section>
<section id="example-4" class="level3">
<h3 class="anchored" data-anchor-id="example-4">Example</h3>
<p>A financial application processing transactions with Kafka, ensuring that each transaction is recorded exactly once in the database to prevent discrepancies in account balances. Kafka’s EOS guarantees that even in the presence of failures or retries, each transaction is processed once and only once, maintaining the integrity of financial records.</p>
</section>
</section>
</section>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>